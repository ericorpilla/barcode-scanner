<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GS1 Code Scanner (iOS & Android Compatible)</title>
    <!-- Include the ZXing library from a CDN -->
    <script type="text/javascript" src="https://unpkg.com/@zxing/library@latest"></script>
    <style>
        /* Basic styles for a clean, mobile-first layout */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main container for the app content */
        .container {
            width: 100%;
            max-width: 600px;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        h1 {
            color: #ffffff;
            margin-bottom: 20px;
        }

        /* Styling for the scanner overlay */
        .scanner-overlay {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            margin-bottom: 20px;
            background-color: #333;
            border-radius: 12px;
            overflow: hidden; /* Ensures video stays within rounded corners */
        }

        /* Video element for camera stream */
        #video-preview {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none; /* Hidden by default */
        }
        
        #video-preview.active {
            display: block;
        }
        
        /* Red square to guide the user */
        .scan-line {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60%; /* Smaller width */
            height: 80%; /* Adjusted height to create a square within the 4:3 aspect ratio parent */
            border: 2px solid red;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
            display: none; /* Hidden until scanning starts */
        }
        
        #video-preview.active + .scan-line {
            display: block;
        }

        /* Button styling */
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-top: 20px;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }

        /* Result display area */
        #result-container {
            margin-top: 25px;
            padding: 15px;
            background-color: #1e1e1e;
            border-radius: 8px;
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            word-break: break-all;
        }
        
        #result-text {
            font-size: 1.1em;
            font-weight: bold;
            color: #4CAF50; /* Green color for success */
            text-align: left;
            line-height: 1.6;
            width: 100%;
        }

        /* Informational messages */
        #info-message {
            margin-top: 15px;
            color: #aaa;
        }

    </style>
</head>
<body>

    <div class="container">
        <h1>GS1 Code Scanner</h1>
        
        <div class="scanner-overlay">
            <video id="video-preview" playsinline></video>
            <div class="scan-line"></div>
        </div>

        <div id="result-container">
            <div id="result-text">Scan result will appear here</div>
        </div>

        <button id="scan-button">Start Scan</button>
        
        <p id="info-message">Click "Start Scan" to use your camera.</p>
    </div>

    <script>
        (function() {
            // DOM element references
            const video = document.getElementById('video-preview');
            const scanButton = document.getElementById('scan-button');
            const resultText = document.getElementById('result-text');
            const infoMessage = document.getElementById('info-message');

            let isScanning = false;
            let audioContext; // To hold the AudioContext for the beep sound
            let codeReader; // Will be initialized after library loads

            // --- Wait for the ZXing library to be ready ---
            window.addEventListener('load', () => {
                // Check if ZXing is loaded
                if (typeof ZXing === 'undefined') {
                    infoMessage.textContent = 'Error: Scanning library failed to load.';
                    scanButton.disabled = true;
                    console.error("ZXing library not loaded.");
                    return;
                }
                
                // --- Create CLEANED UP hints for the reader ---
                const hints = new Map();
                // Specify only the most relevant barcode formats
                const formats = [
                    ZXing.BarcodeFormat.CODE_128,
                    ZXing.BarcodeFormat.EAN_13,
                    ZXing.BarcodeFormat.DATA_MATRIX,
                    ZXing.BarcodeFormat.QR_CODE,
                ];
                hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
                
                // *** THIS IS THE KEY FIX FOR GS1 ***
                // Tell the library to assume the barcode is a GS1 type
                hints.set(ZXing.DecodeHintType.ASSUME_GS1, true);

                // Initialize the ZXing code reader with the more focused hints
                codeReader = new ZXing.BrowserMultiFormatReader(hints);
                
                // Enable the button now that the library is ready
                scanButton.disabled = false;
                infoMessage.textContent = 'Ready to scan. Click "Start Scan".';
            });
            
            // Disable button by default until library is loaded
            scanButton.disabled = true;
            infoMessage.textContent = 'Loading scanning library...';


            // --- Audio Beep Function ---
            function playBeep() {
                if (!audioContext) return;
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.frequency.value = 880;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.05);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.2);
            }

            // --- Event Listener for the Scan Button ---
            scanButton.addEventListener('click', () => {
                if (!codeReader) {
                    infoMessage.textContent = 'Scanning library is not ready.';
                    return;
                }
                // Initialize AudioContext on user interaction
                if (!audioContext) {
                    try {
                        audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.warn("Web Audio API is not supported in this browser.");
                    }
                }

                if (isScanning) {
                    stopScan();
                } else {
                    startScan();
                }
            });

            // --- Core Functions ---
            async function startScan() {
                isScanning = true;
                scanButton.textContent = 'Stop Scan';
                resultText.innerHTML = 'Point camera at a barcode...';
                infoMessage.textContent = 'Starting camera...';
                video.classList.add('active');

                // --- Define constraints for a faster, more efficient video stream ---
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 640 }, // Lower resolution for faster processing
                        height: { ideal: 480 }
                    }
                };

                try {
                    // Use decodeFromConstraints for better performance
                    await codeReader.decodeFromConstraints(constraints, 'video-preview', (result, err) => {
                        if (result) {
                            // A barcode was successfully found
                            codeReader.reset(); // Stop the camera stream
                            
                            const foundBarcode = result.getText();
                            handleFoundBarcode(foundBarcode);
                        }
                        if (err && !(err instanceof ZXing.NotFoundException)) {
                            // An error other than "not found" occurred
                            console.error('ZXing detection error:', err);
                        }
                    });
                } catch (err) {
                    console.error("Camera access or initialization error:", err);
                    infoMessage.textContent = `Could not access camera. Please grant permission. (${err.name})`
                    stopScan();
                }
            }
            
            function handleFoundBarcode(barcodeData) {
                // Set scanning to false immediately to prevent re-triggering
                isScanning = false; 
                playBeep();
                if ('vibrate' in navigator) navigator.vibrate(200);

                const parsedData = parseGS1Data(barcodeData);

                if ('geolocation' in navigator) {
                    infoMessage.textContent = 'Success! Getting location...';
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude;
                            const lon = position.coords.longitude;
                            const displayHtml = `<strong>GTIN:</strong> ${parsedData.gtin}<br>` +
                                              `<strong>LOT:</strong> ${parsedData.lot}<br>` +
                                              `<strong>Expiry:</strong> ${parsedData.expiry}<br>` +
                                              `<strong>Geolocation:</strong> ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                            finalizeScan(displayHtml, 'Success! Scan complete.');
                        },
                        (error) => {
                            console.warn(`Geolocation error (${error.code}): ${error.message}`);
                            const displayHtml = `<strong>GTIN:</strong> ${parsedData.gtin}<br>` +
                                              `<strong>LOT:</strong> ${parsedData.lot}<br>` +
                                              `<strong>Expiry:</strong> ${parsedData.expiry}<br>` +
                                              `<strong style="color: #ffcc00;">Geolocation:</strong> Not available`;
                            finalizeScan(displayHtml, 'Could not get location. Scan complete.');
                        }
                    );
                } else {
                    // Geolocation not supported by browser
                    const displayHtml = `<strong>GTIN:</strong> ${parsedData.gtin}<br>` +
                                      `<strong>LOT:</strong> ${parsedData.lot}<br>` +
                                      `<strong>Expiry:</strong> ${parsedData.expiry}<br>` +
                                      `<strong style="color: #ffcc00;">Geolocation:</strong> Not supported`;
                    finalizeScan(displayHtml, 'Geolocation not supported. Scan complete.');
                }
            }

            function stopScan() {
                isScanning = false;
                if (codeReader) {
                    codeReader.reset(); // This stops the camera and scanning process
                }
                video.classList.remove('active');
                scanButton.textContent = 'Start Scan';
                infoMessage.textContent = 'Scan stopped. Click to start again.';
            }
            
            function finalizeScan(displayHtml, message) {
                 resultText.innerHTML = displayHtml;
                 infoMessage.textContent = message;
                 // --- Reset the UI after a successful scan ---
                 video.classList.remove('active');
                 scanButton.textContent = 'Start Scan';
            }

            function parseGS1Data(data) {
                const result = { gtin: 'N/A', expiry: 'N/A', lot: 'N/A' };
                // The FNC1 character is often represented as ASCII character 29 or \x1d
                const fnc1 = String.fromCharCode(29); 
                const dataWithSeparators = data.replace(/\x1d/g, fnc1); // Ensure all FNC1 codes are consistent

                const aiDefs = {
                    '01': { length: 14, name: 'gtin' },
                    '17': { length: 6, name: 'expiry' },
                    '10': { length: null, name: 'lot' }
                };

                let remainingData = dataWithSeparators;
                
                // GS1-128 barcodes start with a special FNC1 character. 
                // We find the first real Application Identifier (AI) to start parsing.
                if (remainingData.startsWith(fnc1)) {
                    remainingData = remainingData.substring(1);
                }

                while (remainingData.length > 0) {
                    const currentAi = remainingData.substring(0, 2);
                    let consumed = false;

                    if (aiDefs[currentAi] && aiDefs[currentAi].length !== null) { // Fixed-length AI
                        const def = aiDefs[currentAi];
                        const dataLength = def.length;
                        if (remainingData.length >= 2 + dataLength) {
                            const value = remainingData.substring(2, 2 + dataLength);
                            if (def.name === 'gtin') {
                                result.gtin = value;
                            } else if (def.name === 'expiry') {
                                const year = `20${value.substring(0, 2)}`;
                                const month = value.substring(2, 4);
                                const day = value.substring(4, 6);
                                result.expiry = `${day}/${month}/${year}`;
                            }
                            remainingData = remainingData.substring(2 + dataLength);
                            consumed = true;
                        }
                    } else if (currentAi === '10') { // Variable-length LOT AI
                        let lotData = remainingData.substring(2);
                        let separatorIndex = lotData.indexOf(fnc1);

                        if (separatorIndex !== -1) {
                            result.lot = lotData.substring(0, separatorIndex);
                            remainingData = lotData.substring(separatorIndex + 1); // Skip the separator
                        } else {
                            // If no separator, the rest of the string is the LOT
                            result.lot = lotData;
                            remainingData = "";
                        }
                        consumed = true;
                    }

                    if (!consumed) {
                        // If we hit an AI we don't know, or data is malformed, stop.
                        break; 
                    }
                }
                return result;
            }
        })();
    </script>

</body>
</html>

